<!doctype html>
<html>
  <head>
    <title>EX-Gateway script tester</title>
    <style>
    .textarea {
      width: 80%;
      height: 40vh;
    }
    </style>
  </head>
  <body>
    <h1>EX-Gateway command list and tester</h1>
    <h2>Set environment</h2>
    <ul>
      <li><a href="#" class="env" onclick="setEnv('local')">Local</a></li>
      <li><a href="#" class="env" onclick="setEnv('gcp')">GCP</a></li>
      <li><a href="#" class="env" onclick="setEnv('alpha_gcp')">Alpha GCP</a></li>
    </ul>
    <h2>Login</h2>
    <form id="authForm">
      <input type="text" name="username" placeholder="username" /><br />
      <input type="password" name="password" placeholder="password" />
      <input type="button" onclick="authUser(this)" value="Authorise" />
    </form>
    <pre id="authResponse"></pre>
    <ul>
      <li><a href="#" class="action" onclick="actionClick(this)">Authorize User</a><input type="hidden" name="action" value="authorize" /><input type="hidden" name="payload" value='{
        "method": "oauth2",
        "token": "userToken"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Create organisation</a><input type="hidden" name="action" value="admin_organisation_create" /><input type="hidden" name="payload" value='{
        "name": "organisation-name",
        "website": "www.example.com",
        "primary_contact": {
          "id": "091e8b52-8506-4512-b75e-149ee51c4f04"
        }
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Update organisation</a><input type="hidden" name="action" value="admin_organisation_update" /><input type="hidden" name="payload" value='{
        "id": "c3a7a5bf-276a-415e-bf99-53108c277561",
        "name": "organisation-name",
        "website": "www.example.com",
        "primary_contact": {
          "id": "091e8b52-8506-4512-b75e-149ee51c4f04"
        }
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Read organisation</a><input type="hidden" name="action" value="admin_organisation_read" /><input type="hidden" name="payload" value='{
        "id": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Create event</a><input type="hidden" name="action" value="admin_event_create" /><input type="hidden" name="payload" value='{
        "name": "event-name",
        "website": "www.example.com",
        "start_date": "2020-08-21 08:00:00",
        "end_date": "2020-08-22 17:00:00",
        "organisation": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Create nested event</a><input type="hidden" name="action" value="admin_event_create" /><input type="hidden" name="payload" value='{
        "name": "event-name",
        "website": "www.example.com",
        "start_date": "2020-08-21 08:00:00",
        "end_date": "2020-08-22 17:00:00",
        "event": "",
        "organisation": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Update event</a><input type="hidden" name="action" value="admin_event_update" /><input type="hidden" name="payload" value='{
        "id": "",
        "start_date": "2020-08-21 08:30:00",
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Read event</a><input type="hidden" name="action" value="admin_event_read" /><input type="hidden" name="payload" value='{
        "id": ""
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Create itinerary</a><input type="hidden" name="action" value="admin_itinerary_create" /><input type="hidden" name="payload" value='{
        "name": "event-name",
        "website": "www.example.com",
        "organisation": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Update itinerary</a><input type="hidden" name="action" value="admin_itinerary_update" /><input type="hidden" name="payload" value='{
        "name": "event-name",
        "website": "www.example.com",
        "organisation": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Read itinerary</a><input type="hidden" name="action" value="admin_itinerary_read" /><input type="hidden" name="payload" value='{
        "id": ""
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Create itinerary item</a><input type="hidden" name="action" value="admin_item_create" /><input type="hidden" name="payload" value='{
        "title": "Moderated Discussion",
        "start_date": "2020-08-21 08:00:00",
        "end_date": "2020-08-21 09:00:00",
        "itinerary": "uuid|required",
        "landing_page": "uuid|optional",
        "type": "chat",
        "configuration": {
          "moderation": "post-moderate",
          "moderators": [
            "091e8b52-8506-4512-b75e-149ee51c4f04"
          ],
          "threads": true,
          "private": true
        }
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Update itinerary item</a><input type="hidden" name="action" value="admin_item_update" /><input type="hidden" name="payload" value='{
        "name": "event-name",
        "website": "www.example.com",
        "organisation": "c3a7a5bf-276a-415e-bf99-53108c277561"
      }' /></li>
      <li><a href="#" class="action" onclick="actionClick(this)">Read itinerary item</a><input type="hidden" name="action" value="admin_item_read" /><input type="hidden" name="payload" value='{
        "id": ""
      }' /></li>
    </ul>
    <h3>Action: <span id="action" /></h3>
    <textarea id="payload" class="textarea"></textarea>
    <pre id="response"></pre>
    <input type="button" id="submit" value="Send request" />
    <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
    <script>
      let socket;
      const envs = {
        local: {
          auth: "http://localhost:8881",
          gateway: "http://localhost:8880"
        },
        gcp: {
          auth: "https://api.extream.app/auth",
          gateway: "https://gateway.extream.app"
        },
        alpha_gcp: {
          auth: "https://ex-auth-dot-stoked-reality-284921.ew.r.appspot.com",
          gateway: "https://stoked-reality-284921.ew.r.appspot.com"
        }
      }
      let env = envs.local;
      const setEnv = (setEnv) => {
        env = envs[setEnv];
      }
      const authUser = async () => {
        const form = document.querySelector('#authForm');
        const username = form.querySelector("input[name='username']").value;
        const password = form.querySelector("input[name='password']").value;
        const params = {
          username,
          password,
          grant_type: 'password',
          client_id: 'null',
          client_secret: 'null'
        };
        const auth = await fetch(`${env.auth}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: Object.keys(params).map(key => key + '=' + params[key]).join('&')
        });
        try {
          const resp = await auth.json();
          if (resp.access_token) {
            env.access_token = resp.access_token;
            socket = io(`${env.gateway}?x-auth=${env.access_token}`);
            document.getElementById('authResponse').innerHTML = JSON.stringify(resp, null, 2);
            socket.emit(`authorize`, { method: 'oauth2', token: env.access_token });
            socket.on(`authorized`, displayResp);
            socket.on(`unauthorized`, displayResp);
            socket.on(`mfa`, displayResp);
          }
        } catch (error) {
          document.getElementById('authResponse').innerHTML = error;
        }
      };      
      const actionClick = (el) => {
        const action = el.nextSibling.value;
        const payload = el.nextSibling.nextSibling.value;
        document.getElementById('action').innerHTML = action;
        document.getElementById('payload').value = JSON.stringify(JSON.parse(payload), null, 2);
      };
      const displayResp = (data) => {
        document.getElementById('response').innerHTML = JSON.stringify(data, null, 2);
      };
      document.getElementById('submit').addEventListener('click', () => {
        socket.on(`${document.getElementById('action').innerHTML}`, displayResp);
        socket.emit(document.getElementById('action').innerHTML, JSON.parse(document.getElementById('payload').value));
      });
    </script>
  </body>
</html>